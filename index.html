<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Interculture International Airport</title>

<style>
:root {
  --primary: #2563eb;
  --primary-dark: #1e40af;
  --accent: #22c55e;
  --warning: #f59e0b;
  --danger: #ef4444;
  --bg: #f1f5f9;
  --card: #ffffff;
  --text: #0f172a;
  --muted: #64748b;
}

* { box-sizing: border-box; }

body {
  margin: 0;
  padding: 30px;
  font-family: "Inter", "Segoe UI", Arial, sans-serif;
  background: linear-gradient(135deg, #eef2ff, #f8fafc);
  color: var(--text);
  font-size: 18px;
}

/* ---- TOP BAR / BUTTONS ---- */
.top-right {
  position: fixed;
  top: 18px;
  right: 18px;
  display: flex;
  gap: 10px;
  z-index: 9999;
}

/* Top-left */
.top-left {
  position: fixed;
  top: 18px;
  left: 18px;
  display: flex;
  gap: 10px;
  z-index: 9999;
}

/* Give the title enough top room when buttons are fixed */
.page-title {
  padding-top: 28px;
}

button, .link-btn {
  border-radius: 14px;
  border: none;
  padding: 14px 16px;
  font-size: 16px;
  cursor: pointer;
  background: var(--primary);
  color: white;
  transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s;
  box-shadow: 0 8px 20px rgba(37, 99, 235, 0.25);
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  user-select: none;
  white-space: nowrap;
}

button:hover, .link-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 26px rgba(37, 99, 235, 0.35);
}

button:active, .link-btn:active {
  transform: translateY(0);
  box-shadow: 0 6px 14px rgba(37, 99, 235, 0.25);
}

button:disabled {
  cursor: not-allowed;
  opacity: 0.45;
  transform: none !important;
  box-shadow: 0 6px 14px rgba(0,0,0,0.08) !important;
}

/* On smaller screens put buttons in normal flow */
@media (max-width: 820px) {
  .top-right {
    position: static;
    justify-content: flex-end;
    margin-bottom: 10px;
  }
  .top-left {
    position: static;
    justify-content: flex-start;
    margin-bottom: 10px;
  }
  .page-title {
    padding-top: 0;
  }
}

/* ---- TITLE ---- */
h1 {
  text-align: center;
  font-size: 42px;
  margin: 10px 0 40px;
  letter-spacing: 0.5px;
}

/* Rounds */
.rounds {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 20px;
  margin-bottom: 35px;
}

.round-btn {
  font-weight: 700;
  font-size: 20px;
}

/* Containers */
.puzzle-container,
.code-container {
  display: none;
  background: var(--card);
  border-radius: 22px;
  padding: 30px;
  margin-top: 25px;
  box-shadow: 0 20px 40px rgba(0,0,0,0.08);
}

.puzzle-btn {
  width: 100%;
  margin: 10px 0;
  background: #f8fafc;
  color: var(--text);
  font-weight: 600;
  box-shadow: 0 4px 10px rgba(0,0,0,0.08);
}

.puzzle-btn:hover { background: #eef2ff; }

.puzzle-btn.solved {
  background: #ecfdf5;
  border: 2px solid rgba(34, 197, 94, 0.35);
}

.puzzle-btn.solved:hover { background: #dcfce7; }

input {
  width: 100%;
  max-width: 360px;
  padding: 14px 16px;
  font-size: 18px;
  border-radius: 12px;
  border: 2px solid #e5e7eb;
  outline: none;
  margin-right: 10px;
  transition: border 0.15s ease, box-shadow 0.15s ease;
}

input:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.15);
}

.message {
  margin-top: 18px;
  font-weight: 700;
  font-size: 20px;
}

.hint-btn {
  display: none;
  margin-top: 15px;
  background: var(--warning);
  box-shadow: 0 8px 20px rgba(245, 158, 11, 0.35);
}

#giveUpButton {
  background: var(--danger);
  box-shadow: 0 8px 20px rgba(239, 68, 68, 0.35);
}

.hint-text {
  display: none;
  margin-top: 20px;
  background: #fff7ed;
  border-left: 6px solid var(--warning);
  padding: 18px;
  border-radius: 14px;
  font-weight: 500;
}

.solution-text {
  display: none;
  margin-top: 20px;
  background: #ecfdf5;
  border-left: 6px solid var(--accent);
  padding: 18px;
  border-radius: 14px;
  font-weight: 600;
}

.solution-actions {
  margin-top: 12px;
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.popup {
  display: none;
  margin-top: 25px;
  background: #f8fafc;
  border-radius: 18px;
  padding: 25px;
  box-shadow: 0 12px 30px rgba(0,0,0,0.15);
}

.popup button {
  margin-right: 10px;
  margin-top: 10px;
}

/* Modal base */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(2, 6, 23, 0.55);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  padding: 18px;
}

.modal {
  width: min(900px, 100%);
  background: var(--card);
  border-radius: 18px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.25);
  padding: 22px 22px 18px;
  max-height: 85vh;
  overflow: auto;
}

.modal h2 {
  margin: 0 0 10px;
  font-size: 22px;
}

.modal p {
  margin: 8px 0;
  line-height: 1.45;
  color: var(--text);
}

.modal .modal-actions {
  margin-top: 14px;
  display: flex;
  gap: 10px;
  justify-content: flex-end;
}

.modal .secondary {
  background: #e2e8f0;
  color: #0f172a;
  box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
}

/* Seating plan image */
.seating-image {
  max-width: 100%;
  border-radius: 16px;
  box-shadow: 0 12px 30px rgba(0,0,0,0.25);
}

/* ---- ADMIN PANEL ---- */
.admin-login-row{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
  margin-top: 10px;
}

.admin-login-row input{
  max-width: 320px;
}

.admin-error{
  color: var(--danger);
  font-weight: 700;
  margin-top: 10px;
  display:none;
}

.admin-content{
  display:none;
  margin-top: 12px;
}

.admin-grid{
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
  gap: 14px;
  margin-top: 14px;
}

.admin-round-title{
  margin-top: 14px;
  margin-bottom: 6px;
  font-weight: 800;
  color: var(--muted);
  letter-spacing: .2px;
  font-size: 14px;
  text-transform: uppercase;
}

.admin-puzzle-btn{
  aspect-ratio: 1 / 1;
  width: 100%;
  border-radius: 14px;
  border: 1px solid #334155;
  padding: 10px;
  font-size: 14px;
  font-weight: 800;
  cursor: pointer;
  background: linear-gradient(145deg, #1f2937, #020617);
  color: #ffffff;
  transition: transform 0.12s ease, filter 0.12s ease, box-shadow 0.12s ease;
  box-shadow: 0 10px 22px rgba(2, 6, 23, 0.18);
}

.admin-puzzle-btn:hover{
  transform: translateY(-2px) scale(1.02);
  filter: brightness(1.12);
  box-shadow: 0 14px 26px rgba(2, 6, 23, 0.24);
}

.admin-puzzle-btn:active{
  transform: translateY(0) scale(0.99);
  filter: brightness(1.02);
  box-shadow: 0 10px 22px rgba(2, 6, 23, 0.18);
}

.admin-details{
  margin-top: 14px;
  background: #f8fafc;
  border-radius: 14px;
  padding: 14px;
  border: 1px solid rgba(15, 23, 42, 0.08);
}

.admin-details .label{
  font-weight: 800;
  color: var(--muted);
  text-transform: uppercase;
  font-size: 12px;
  letter-spacing: .3px;
  margin-top: 8px;
}

.admin-details code{
  display:block;
  margin-top: 6px;
  padding: 10px 12px;
  border-radius: 12px;
  background: #0b1220;
  color: #e2e8f0;
  overflow-x:auto;
}
</style>
</head>

<body>

<!-- Top-left controls -->
<div class="top-left">
  <button id="seatingPlanBtn" aria-haspopup="dialog" aria-controls="seatingOverlay">Seating Plan</button>
</div>

<!-- Top-right controls -->
<div class="top-right">
  <button id="helpBtn" aria-haspopup="dialog" aria-controls="helpOverlay">Help</button>
  <button id="adminBtn" aria-haspopup="dialog" aria-controls="adminOverlay">Admin Panel</button>
  <button id="resetBtn" type="button">Reset Progress</button>
  <a
    class="link-btn"
    id="opalLink"
    href="https://bildungsportal.sachsen.de/opal/auth/RepositoryEntry/52766048256"
    target="_blank"
    rel="noopener noreferrer"
  >
    Link to OPAL
  </a>
</div>

<!-- Help modal -->
<div class="modal-overlay" id="helpOverlay" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
  <div class="modal">
    <h2 id="helpTitle">How it works</h2>
    <p><strong>1)</strong> Click on <strong>“Link to OPAL”</strong> (top right) and solve the puzzle there.</p>
    <p><strong>2)</strong> After solving the puzzle, OPAL gives you a <strong>secret code</strong>.</p>
    <p><strong>3)</strong> Come back to this website and enter the <strong>secret code</strong> into the input field.</p>
    <p><strong>4)</strong> When the code is correct, the <strong>solution is shown</strong>. You can then click <strong>Next puzzle</strong>.</p>
    <div class="modal-actions">
      <button class="secondary" id="helpCloseBtn">Close</button>
    </div>
  </div>
</div>

<!-- Seating Plan modal -->
<div class="modal-overlay" id="seatingOverlay" role="dialog" aria-modal="true" aria-labelledby="seatingTitle">
  <div class="modal">
    <h2 id="seatingTitle">Seating Plan</h2>
    <p>Choose the number of players:</p>

    <div class="rounds" style="margin-bottom: 16px;">
      <button type="button" onclick="showSeating(4)">4 Players</button>
      <button type="button" onclick="showSeating(5)">5 Players</button>
      <button type="button" onclick="showSeating(6)">6 Players</button>
      <button type="button" onclick="showSeating(7)">7 Players</button>
      <button type="button" onclick="showSeating(8)">8 Players</button>
      <button type="button" onclick="showSeating(9)">9 Players</button>
      <button type="button" onclick="showSeating(10)">10 Players</button>
      <button type="button" onclick="showSeating(11)">11 Players</button>
      <button type="button" onclick="showSeating(12)">12 Players</button>

      <button type="button" onclick="showSeating(13)">13 Players</button>
      <button type="button" onclick="showSeating(14)">14 Players</button>
      <button type="button" onclick="showSeating(15)">15 Players</button>
      <button type="button" onclick="showSeating(16)">16 Players</button>
      <button type="button" onclick="showSeating(17)">17 Players</button>
      <button type="button" onclick="showSeating(18)">18 Players</button>
      <button type="button" onclick="showSeating(19)">19 Players</button>

      <button type="button" onclick="showSeating(20)">20 Players</button>
      <button type="button" onclick="showSeating(21)">21 Players</button>
      <button type="button" onclick="showSeating(22)">22 Players</button>
      <button type="button" onclick="showSeating(23)">23 Players</button>
      <button type="button" onclick="showSeating(24)">24 Players</button>
    </div>

    <div id="seatingImageContainer" style="text-align:center; padding-top: 6px;">
      <p style="color: var(--muted); margin: 0;">Select a button to view the seating plan image.</p>
    </div>

    <div class="modal-actions">
      <button class="secondary" type="button" id="seatingCloseBtn">Close</button>
    </div>
  </div>
</div>

<!-- Admin Panel modal -->
<div class="modal-overlay" id="adminOverlay" role="dialog" aria-modal="true" aria-labelledby="adminTitle">
  <div class="modal">
    <h2 id="adminTitle">Admin Panel</h2>

    <div id="adminLogin">
      <p style="margin: 0; color: var(--muted);">Enter the admin password to view puzzle codes.</p>

      <div class="admin-login-row">
        <input type="password" id="adminPassword" placeholder="Password" autocomplete="current-password" />
        <button id="adminLoginBtn" type="button">Enter</button>
      </div>

      <div class="admin-error" id="adminError">Wrong password.</div>
    </div>

    <div class="admin-content" id="adminContent">
      <p style="margin: 0; color: var(--muted);">
        Select a puzzle to reveal its accepted <strong>secret codes</strong>.
      </p>

      <div id="adminPuzzleList" style="margin-top: 10px;"></div>

      <div class="admin-details" id="adminDetails" aria-live="polite">
        <div style="font-weight: 800;">Pick a puzzle button to view details.</div>
        <div class="label">Codes</div>
        <code id="adminCodes">—</code>
      </div>
    </div>

    <div class="modal-actions">
      <button class="secondary" type="button" id="adminCloseBtn">Close</button>
    </div>
  </div>
</div>


<!-- Reset Progress modal -->
<div class="modal-overlay" id="resetOverlay" role="dialog" aria-modal="true" aria-labelledby="resetTitle">
  <div class="modal">
    <h2 id="resetTitle">Reset progress</h2>
    <p style="margin: 0;">
      Are you sure you want to delete the entire progress? You will start again from the Round 1.
    </p>
    <div class="modal-actions">
      <button class="secondary" type="button" id="resetCancelBtn">Cancel</button>
      <button type="button" id="resetConfirmBtn">Yes, reset</button>
    </div>
  </div>
</div>


<h1 class="page-title">✈️ Interculture International Airport</h1>

<div class="rounds" id="rounds"></div>
<div class="puzzle-container" id="puzzleContainer"></div>

<div class="code-container" id="codeContainer">
  <input type="text" id="codeInput" placeholder="Enter secret code" />
  <button id="submitButton">Submit</button>

  <div class="message" id="message"></div>

  <!-- Hints removed -->

  <div class="solution-text" id="solutionText">
    <div id="solutionBody"></div>
    <div class="solution-actions" id="solutionActions"></div>
  </div>

  <div class="popup" id="giveUpPopup">
    <p>Reveal the solution?</p>
    <button id="giveUpYes">Yes</button>
    <button id="giveUpNo">No</button>
  </div>
</div>

<script>
const data = {
  1: {
    "1.1": { codes: ["Diversity", "diversity"], hint: "The words in bold form something.", solution: "Good job you can continue with the next Puzzle." },
    "1.2": { codes: ["DEC", "dec"], hint: "Sort the terms by the number of times they occur.", solution: "Well done wait for the timer to be over and get your stamp" }
  },
  2: {
    "2.1": { codes: ["RVRTN"], hint: "Take the first letter of the first word from top to bottom.", solution: "Good job you can continue with the next Puzzle." },
    "2.2": { codes: ["Comfort Range", "comfort range"], hint: "Write the corresponding alphabetical number under each point.", solution: "Well done wait for the timer to be over and get your stamp" }
  },
  3: {
    "3.1": { codes: ["Dimension"], hint: "The letters in bold form something.", solution: "Good job you can continue with the next Puzzle." },
    "3.2": { codes: ["Missed deadline", "deadline"], hint: "What is the problem?", solution: "Well done wait for the timer to be over and get your stamp" }
  },
  4: {
    "4.1": { codes: ["Culture"], hint: "The words in bold form something.", solution: "Good job you can continue with the next Puzzle." },
    "4.2": { codes: ["RRTG"], hint: "Take the first letter of the first word in the first column.", solution: "Well done wait for the timer to be over and get your stamp" }
  },
  5: {
    "5.1": { codes: ["GE"], hint: "Look at the first letters of the countries in bold.", solution: "Good job you can continue with the next Puzzle." },
    "5.2": { codes: ["ACHT", "8"], hint: "The first letters of the terms indicate a number.", solution: "Well done wait for the timer to be over and get your stamp" }
  },
  6: {
    "6.1": { codes: ["Arch", "Bogen"], hint: "Use the first letters.", solution: "Good job you can continue with the next Puzzle." },
    "6.2": { codes: ["Excitement Frustration Confident Improving", "EFCI"], hint: "The words in bold form something.", solution: "Well done wait for the timer to be over and get your stamp" }
  },
  7: {
    "7.1": { codes: ["AI", "Artificial Intelligence"], hint: "The words in bold form something.", solution: "Good job you can continue with the next Puzzle." },
    "7.2": { codes: ["culture"], hint: "Find the most common word.", solution: "Well done wait for the timer to be over and get your stamp" }
  },
  8: {
    "8.1": { codes: ["Acculturation"], hint: "All answers describe cultural belonging.", solution: "Good job you can continue with the next Puzzle." },
    "8.2": { codes: ["EAUAASA"], hint: "Read the first word of each stage from bottom to top.", solution: "Well done wait for the timer to be over and get your stamp" }
  },
  9: {
    "9.1": { codes: ["Intercultural Sensitivity", "DMIS"], hint: "How people perceive and deal with cultural differences.", solution: "Good job you can continue with the next Puzzle." },
    "9.2": { codes: ["DDMAAI"], hint: "Read the first word of each stage from bottom to top.", solution: "Well done wait for the timer to be over and get your stamp" }
  }
};

const roundsDiv = document.getElementById("rounds");
const puzzleContainer = document.getElementById("puzzleContainer");
const codeContainer = document.getElementById("codeContainer");
const codeInput = document.getElementById("codeInput");
const submitButton = document.getElementById("submitButton");
const message = document.getElementById("message");

const solutionText = document.getElementById("solutionText");
const solutionBody = document.getElementById("solutionBody");
const solutionActions = document.getElementById("solutionActions");
const giveUpPopup = document.getElementById("giveUpPopup");

const helpBtn = document.getElementById("helpBtn");
const helpOverlay = document.getElementById("helpOverlay");
const helpCloseBtn = document.getElementById("helpCloseBtn");

let currentPuzzle = null;
let failedAttempts = 0;
let currentRound = null;
let currentPuzzleKey = null;

const STORAGE_KEY = "airport_puzzle_progress_v1";

function loadProgress() {
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; }
  catch { return {}; }
}
function saveProgress(p) { localStorage.setItem(STORAGE_KEY, JSON.stringify(p)); }
function markSolved(round, puzzleKey) {
  const p = loadProgress();
  const r = String(round);
  p[r] = p[r] || {};
  p[r][puzzleKey] = true;
  saveProgress(p);
}
function isSolved(round, puzzleKey) {
  const p = loadProgress();
  const r = String(round);
  return !!(p[r] && p[r][puzzleKey]);
}

function sortedRounds() {
  return Object.keys(data).map(Number).sort((a,b)=>a-b);
}
function sortedPuzzles(round) {
  return Object.keys(data[round]).sort((a,b) => {
    const [ar, ap] = a.split(".").map(Number);
    const [br, bp] = b.split(".").map(Number);
    return ar - br || ap - bp;
  });
}
function isRoundComplete(round) {
  const r = String(round);
  return sortedPuzzles(r).every(pk => isSolved(r, pk));
}
function isRoundUnlocked(round) {
  const n = Number(round);
  if (n === 1) return true;
  return isRoundComplete(n - 1);
}

/* ✅ FIX: show ALL puzzles of an unlocked round (lets users go back) */
function getVisiblePuzzles(round) {
  const r = String(round);
  if (!isRoundUnlocked(r)) return [];
  return sortedPuzzles(r);
}

function getNextPuzzle(round, puzzleKey) {
  const puzzles = sortedPuzzles(String(round));
  const idx = puzzles.indexOf(String(puzzleKey));
  if (idx === -1) return null;
  return puzzles[idx + 1] || null;
}

function getNextRound(round) {
  const rounds = sortedRounds();
  const idx = rounds.indexOf(Number(round));
  if (idx === -1 || idx === rounds.length - 1) return null;
  return String(rounds[idx + 1]);
}

submitButton.onclick = checkCode;
codeInput.onkeydown = e => { if (e.key === "Enter") checkCode(); };

/* Help modal behavior */
function openHelp() {
  helpOverlay.style.display = "flex";
  setTimeout(() => helpCloseBtn.focus(), 0);
}
function closeHelp() {
  helpOverlay.style.display = "none";
  helpBtn.focus();
}
helpBtn.addEventListener("click", openHelp);
helpCloseBtn.addEventListener("click", closeHelp);
helpOverlay.addEventListener("click", (e) => { if (e.target === helpOverlay) closeHelp(); });

/* Admin modal behavior */
const adminBtn = document.getElementById("adminBtn");
const adminOverlay = document.getElementById("adminOverlay");
const adminCloseBtn = document.getElementById("adminCloseBtn");

const adminLogin = document.getElementById("adminLogin");
const adminPassword = document.getElementById("adminPassword");
const adminLoginBtn = document.getElementById("adminLoginBtn");
const adminError = document.getElementById("adminError");

const adminContent = document.getElementById("adminContent");
const adminPuzzleList = document.getElementById("adminPuzzleList");
const adminCodes = document.getElementById("adminCodes");

const ADMIN_PASS = "InfinityGauntlet";
const ADMIN_SESSION_KEY = "airport_admin_unlocked_v1";

function openAdmin() {
  adminOverlay.style.display = "flex";
  adminError.style.display = "none";
  const unlocked = sessionStorage.getItem(ADMIN_SESSION_KEY) === "1";
  if (unlocked) {
    adminLogin.style.display = "none";
    adminContent.style.display = "block";
    buildAdminList();
    setTimeout(() => adminCloseBtn.focus(), 0);
  } else {
    adminLogin.style.display = "block";
    adminContent.style.display = "none";
    adminPassword.value = "";
    setTimeout(() => adminPassword.focus(), 0);
  }
}

function closeAdmin() {
  adminOverlay.style.display = "none";
  adminBtn.focus();
}

function unlockAdmin() {
  const entered = (adminPassword.value || "").trim().toLowerCase();
  if (entered === ADMIN_PASS.toLowerCase()) {
    sessionStorage.setItem(ADMIN_SESSION_KEY, "1");
    adminError.style.display = "none";
    adminLogin.style.display = "none";
    adminContent.style.display = "block";
    buildAdminList();
  } else {
    adminError.style.display = "block";
  }
}

function buildAdminList() {
  adminPuzzleList.innerHTML = "";
  const grid = document.createElement("div");
  grid.className = "admin-grid";

  const all = [];
  sortedRounds().forEach(round => {
    sortedPuzzles(String(round)).forEach(pk => {
      all.push({ round: String(round), pk });
    });
  });

  all.forEach(({ round, pk }) => {
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "admin-puzzle-btn";
    btn.textContent = pk;
    btn.setAttribute("aria-label", `Puzzle ${pk}`);

    btn.addEventListener("click", () => {
      const item = data[round][pk];
      adminCodes.textContent = (item.codes || []).join(" | ") || "—";
    });

    grid.appendChild(btn);
  });

  adminPuzzleList.appendChild(grid);
  adminCodes.textContent = "—";
}

adminBtn.addEventListener("click", openAdmin);
adminCloseBtn.addEventListener("click", closeAdmin);
adminOverlay.addEventListener("click", (e) => { if (e.target === adminOverlay) closeAdmin(); });
adminLoginBtn.addEventListener("click", unlockAdmin);
adminPassword.addEventListener("keydown", (e) => { if (e.key === "Enter") unlockAdmin(); });


/* Reset progress modal behavior */
const resetBtn = document.getElementById("resetBtn");
const resetOverlay = document.getElementById("resetOverlay");
const resetCancelBtn = document.getElementById("resetCancelBtn");
const resetConfirmBtn = document.getElementById("resetConfirmBtn");

function openReset() {
  resetOverlay.style.display = "flex";
  setTimeout(() => resetCancelBtn.focus(), 0);
}
function closeReset() {
  resetOverlay.style.display = "none";
  resetBtn.focus();
}
function doReset() {
  // clear puzzle progress + admin session
  localStorage.removeItem(STORAGE_KEY);
  sessionStorage.removeItem(ADMIN_SESSION_KEY);
  // reset UI state
  currentPuzzle = null;
  currentRound = "1";
  currentPuzzleKey = null;
  failedAttempts = 0;

  // hide any messages/solution
  message.textContent = "";
  solutionText.style.display = "none";
  solutionBody.textContent = "";
  solutionActions.innerHTML = "";
  giveUpPopup.style.display = "none";
  codeInput.value = "";

  closeReset();
  renderRounds();
  showPuzzles("1");
}

resetBtn.addEventListener("click", openReset);
resetCancelBtn.addEventListener("click", closeReset);
resetOverlay.addEventListener("click", (e) => { if (e.target === resetOverlay) closeReset(); });
resetConfirmBtn.addEventListener("click", doReset);


/* Seating modal behavior */
const seatingBtn = document.getElementById("seatingPlanBtn");
const seatingOverlay = document.getElementById("seatingOverlay");
const seatingCloseBtn = document.getElementById("seatingCloseBtn");
const seatingImageContainer = document.getElementById("seatingImageContainer");

function openSeating() {
  seatingOverlay.style.display = "flex";
  setTimeout(() => seatingCloseBtn.focus(), 0);
}
function closeSeating() {
  seatingOverlay.style.display = "none";
  seatingBtn.focus();
  seatingImageContainer.innerHTML = `<p style="color: var(--muted); margin: 0;">Select a button to view the seating plan image.</p>`;
}

seatingBtn.addEventListener("click", openSeating);
seatingCloseBtn.addEventListener("click", closeSeating);
seatingOverlay.addEventListener("click", (e) => { if (e.target === seatingOverlay) closeSeating(); });

document.addEventListener("keydown", (e) => {
  if (e.key === "Escape" && helpOverlay.style.display === "flex") closeHelp();
  if (e.key === "Escape" && seatingOverlay.style.display === "flex") closeSeating();
  if (e.key === "Escape" && adminOverlay.style.display === "flex") closeAdmin();
  if (e.key === "Escape" && resetOverlay.style.display === "flex") closeReset();
});

function renderRounds() {
  roundsDiv.innerHTML = "";
  sortedRounds().forEach(round => {
    const btn = document.createElement("button");
    btn.className = "round-btn";
    btn.textContent = `Round ${round}`;
    const unlocked = isRoundUnlocked(round);
    btn.disabled = !unlocked;
    if (unlocked) btn.onclick = () => showPuzzles(String(round));
    roundsDiv.appendChild(btn);
  });
}

function showPuzzles(round, autoSelect = true) {
  currentRound = String(round);

  puzzleContainer.innerHTML = "";
  puzzleContainer.style.display = "block";
  codeContainer.style.display = "none";

  if (!isRoundUnlocked(currentRound)) {
    const msg = document.createElement("div");
    msg.textContent = `Round ${currentRound} is locked. Finish Round ${Number(currentRound) - 1} first.`;
    msg.style.padding = "10px";
    puzzleContainer.appendChild(msg);
    return;
  }

  const visible = getVisiblePuzzles(currentRound);

  if (visible.length === 0) {
    const done = document.createElement("div");
    done.style.padding = "10px";
    done.style.fontWeight = "700";
    done.textContent = `Round ${currentRound} complete!`;
    puzzleContainer.appendChild(done);
    return;
  }

  visible.forEach(puzzleKey => {
    const btn = document.createElement("button");
    btn.className = "puzzle-btn";
    const solved = isSolved(currentRound, puzzleKey);
    if (solved) btn.classList.add("solved");
    btn.textContent = solved ? `Puzzle ${puzzleKey} ✔` : `Puzzle ${puzzleKey}`;
    btn.onclick = () => selectPuzzle(currentRound, puzzleKey);
    puzzleContainer.appendChild(btn);
  });

  // Auto-select first unsolved puzzle in the list for convenience
  if (autoSelect) {
    const firstUnsolved = visible.find(pk => !isSolved(currentRound, pk)) || visible[0];
    selectPuzzle(currentRound, firstUnsolved);
  }
}

function selectPuzzle(round, p) {
  currentRound = String(round);
  currentPuzzleKey = String(p);

  currentPuzzle = data[round][p];
  failedAttempts = 0;

  codeInput.value = "";
  message.textContent = "";
  solutionText.style.display = "none";
  solutionBody.textContent = "";
  solutionActions.innerHTML = "";
  giveUpPopup.style.display = "none";

  puzzleContainer.style.display = "block";
  codeContainer.style.display = "block";
  codeInput.focus();
}

/* ✅ FIX: show solution, DO NOT auto-jump. Provide "Next puzzle" button instead. */
function checkCode() {
  if (!currentPuzzle) return;

  const input = codeInput.value.trim().toLowerCase();
  const validCodes = currentPuzzle.codes.map(c => String(c).toLowerCase());

  if (validCodes.includes(input)) {
    message.textContent = "Correct code!";
    // decide message based on puzzle number (.1 or .2)
    const isFirstPuzzle = currentPuzzleKey.endsWith(".1");
    solutionBody.textContent = isFirstPuzzle
      ? "Good job you can continue with the next Puzzle"
      : "Wait till the timer is over and get your stamp";

    // mark solved and refresh round buttons + puzzle list (but keep current view)
    markSolved(currentRound, currentPuzzleKey);
    renderRounds();
    showPuzzles(currentRound, false); // update list without switching selection

    // show solution area + actions
    solutionText.style.display = "block";

    // build actions
    solutionActions.innerHTML = "";

    const backBtn = document.createElement("button");
    backBtn.type = "button";
    backBtn.textContent = "Back to puzzle list";
    backBtn.className = "secondary";
    backBtn.style.background = "#e2e8f0";
    backBtn.style.color = "#0f172a";
    backBtn.style.boxShadow = "0 8px 20px rgba(15, 23, 42, 0.08)";
    backBtn.onclick = () => {
      // simply scroll to list; list is visible above
      puzzleContainer.scrollIntoView({ behavior: "smooth", block: "start" });
    };

    const nextKey = getNextPuzzle(currentRound, currentPuzzleKey);
    if (nextKey) {
      const nextBtn = document.createElement("button");
      nextBtn.type = "button";
      nextBtn.textContent = "Next puzzle";
      nextBtn.onclick = () => selectPuzzle(currentRound, nextKey);
      solutionActions.appendChild(nextBtn);
    } else {
      const nextRound = getNextRound(currentRound);
      if (nextRound && isRoundUnlocked(nextRound)) {
        const nextRoundBtn = document.createElement("button");
        nextRoundBtn.type = "button";
        nextRoundBtn.textContent = `Go to Round ${nextRound}`;
        nextRoundBtn.onclick = () => showPuzzles(nextRound);
        solutionActions.appendChild(nextRoundBtn);
      }
    }

    solutionActions.appendChild(backBtn);

  } else {
    failedAttempts++;
    message.textContent = `Wrong code ${failedAttempts}x`;
    if (failedAttempts >= 3) giveUpPopup.style.display = "block";
  }
}

/* Give up now counts as solved + unlocks next puzzle/round */
document.getElementById("giveUpYes").onclick = () => {
  if (!currentPuzzle) return;

  const isFirstPuzzle = currentPuzzleKey.endsWith(".1");
  solutionBody.textContent = isFirstPuzzle
    ? "Good job you can continue with the next Puzzle"
    : "Wait till the timer is over and get your stamp";

  // ✅ Mark as solved when giving up
  markSolved(currentRound, currentPuzzleKey);
  renderRounds();
  showPuzzles(currentRound, false);

  solutionText.style.display = "block";
  giveUpPopup.style.display = "none";

  // build actions (same as correct code)
  solutionActions.innerHTML = "";

  const backBtn = document.createElement("button");
  backBtn.type = "button";
  backBtn.textContent = "Back to puzzle list";
  backBtn.className = "secondary";
  backBtn.style.background = "#e2e8f0";
  backBtn.style.color = "#0f172a";
  backBtn.style.boxShadow = "0 8px 20px rgba(15, 23, 42, 0.08)";
  backBtn.onclick = () => {
    puzzleContainer.scrollIntoView({ behavior: "smooth", block: "start" });
  };

  const nextKey = getNextPuzzle(currentRound, currentPuzzleKey);
  if (nextKey) {
    const nextBtn = document.createElement("button");
    nextBtn.type = "button";
    nextBtn.textContent = "Next puzzle";
    nextBtn.onclick = () => selectPuzzle(currentRound, nextKey);
    solutionActions.appendChild(nextBtn);
  } else {
    const nextRound = getNextRound(currentRound);
    if (nextRound && isRoundUnlocked(nextRound)) {
      const nextRoundBtn = document.createElement("button");
      nextRoundBtn.type = "button";
      nextRoundBtn.textContent = `Go to Round ${nextRound}`;
      nextRoundBtn.onclick = () => showPuzzles(nextRound);
      solutionActions.appendChild(nextRoundBtn);
    }
  }

  solutionActions.appendChild(backBtn);
};

document.getElementById("giveUpNo").onclick = () => giveUpPopup.style.display = "none";

/* Seating plan images */
function showSeating(players) {
  const images = {
    4: "4 Player.png",
    5: "5 Players.png",
    6: "6 Players.png",
    7: "7 Players.png",
    8: "8 Players.png",
    9: "9 Players.png",
    10: "10 Players.png",
    11: "11 Player.png",
    12: "12 Players.png",
    13: "13 Players.png",
    14: "14 Players.png",
    15: "15 Players.png",
    16: "16 Players.png",
    17: "17 Players.png",
    18: "18 Player.png",
    19: "19 Players.png",
    20: "20 Players.png",
    21: "21 Players (2).png",
    22: "22 Players (2).png",
    23: "23 Players.png",
    24: "24 Players.png"
  };

  const src = images[players];
  if (!src) {
    seatingImageContainer.innerHTML = `<p style="color: var(--danger); font-weight: 700; margin: 0;">No image found for ${players} players.</p>`;
    return;
  }

  seatingImageContainer.innerHTML = `
    <img class="seating-image"
      src="${src}"
      alt="${players} Players Seating Plan"
    />
  `;
}

/* init */
renderRounds();
showPuzzles("1");
</script>

</body>
</html>
